local module = loadfile('/MWP/lib/module.lua')()
module.clear_module_cache()
local tasklib = module.require('/MWP/lib/yielding')
local moveAPI = module.require('/MWP/lib/movement/move')

local testTask1 = tasklib.Task:new {
    name = 'Test1',
    procedure = function()
        print('Entered task1 ...')
        print(thisTask.name)

        promise = thisTask:requestPromise {
            questionData = {
                exampleDatum = 'potato'
            },
            kind = 'example_promise'
        }

        repeat
            thisTask:yield({promise})
        until promise.resolved
        print('Promise is resolved!')
        answer = promise.answerData
        promise.dataWasAccessed = true
        print(answer.exampleAnswer)

        promise2 = thisTask:requestPromise {
            questionData = {
                exampleDatum = 'kiwi'
            },
            kind = 'example_promise'
        }

        repeat
            thisTask:yield({promise2})
        until promise2.resolved
        print('Promise2 is resolved!')
        answer = promise2.answerData
        promise.dataWasAccessed = true
        print(answer.exampleAnswer)

        print('Waiting for a key press [e]')
        repeat
            local event, key = os.pullEvent('key')
            print(' ------> Received event ' .. event)
        until key == keys.e
        print('Done waiting')


        response = vector.new(gps.locate())
        print('Just resumed from yield. Received: ' .. response:tostring())

        moveAPI.goTo(response + vector.new(0,10,0))
        moveAPI.goTo(response)
        -- Hacky stuff to terinate the code
        thisTask.enclosingTaskSequence.enclosingTaskSequence:unqueueTask(thisTask.enclosingTaskSequence)

        return thisTask:terminate("We're done buddy.")
    end
}

local testTask2 = tasklib.Task:new {
    name = 'Test2',
    registeredOutcome = 'example_promise',
    procedure = function()
        while true do
            print('Entered task2 ...')
            promisesToResolve = thisTask:findPromisesToResolve()

            for _,promise in pairs(promisesToResolve) do
                print('Found a promise of type ' .. promise.kind)
                if promise.kind == 'example_promise' then
                    promise.answerData = {
                        exampleAnswer = 'Answered ' .. promise.questionData.exampleDatum
                    }
                    promise.resolved = true
                end
            end

            print('Resolved the promises')
            thisTask.enclosingTaskSequence:unqueueTask(thisTask)

            thisTask:yield()
        end
    end
}

local test_os_task = tasklib.OSEventHandler:new()

local testTaskSequence = tasklib.TaskSequence:new {
    name = 'TestTaskSequence'
}

local otherTaskSequence = tasklib.TaskSequence:new {
    name = 'OtherTaskSequence'
}

testTask2:registerToTaskSequence(testTaskSequence)
testTaskSequence:registerToRegisteredTasks(testTask2)
otherTaskSequence:registerToRegisteredTasks(test_os_task)

testTaskSequence:queueTask(testTask1)

otherTaskSequence:queueTask(testTaskSequence)


repeat
    local doBreak = true
    status = otherTaskSequence:run()
    for k,v in pairs(otherTaskSequence.pendingTasks) do
        doBreak = false
        break
    end
until doBreak
